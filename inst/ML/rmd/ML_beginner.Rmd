---
title: "Title of your Descriptive Analyses"
date: \today
output:
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    #code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(out.width = "80%")
```

# Data Loading

```{r}
# specify variables here
dir_input <- "./data/"
file_train <- "train.csv"
file_test <- "test.csv"
```

```{r}
data_train <- data.table::fread(
  file = paste0(dir_input, file_train),
  header = T,
  stringsAsFactors = F
)

data_test <- data.table::fread(
  file = paste0(dir_input, file_test),
  header = T,
  stringsAsFactors = F
)
```

# First Data Overview 
# Identify And Define ID_COL and TARGET_COL

```{r}
ID_COL <- "YOUR_ID_CODE_HERE"
TARGET_COL <- "YOUR_TARGET_ID_HERE"
```

# Data Preprocessing

## Combine Data

```{r}
# add type col to train_data
train_data[,type:="train"]
# add target col + type to test_data
test_data[,(TARGET_COL):=NA][
  ,type:="test"
]
# merge datasets for uniform preprocessing
dataset <- rbind(train_data, test_data)
rm(train_data, test_data, data_input)
invisible(gc())
```

## Check And Set Variable Types

```{r}
# Define Variable types
dataset[,(ID_COL):=as.character(get(ID_COL))][
  , type:=as.character(type)
][
  , (TARGET_COL):=factor(get(TARGET_COL))
]
# factors
#vec_cat <- colnames(dataset)[]
#dataset[,(vec_cat):=lapply(.SD, as.factor), .SDcols=vec_cat]
# numeric
vec_num <- colnames(dataset)[colnames(dataset) %!in% c(ID_COL, TARGET_COL, "type")]
# dataset[,(vec_num):=lapply(.SD, function(x){as.numeric(as.character(x))}), .SDcols=vec_num]
```

# Descriptive Analysis Of Training Data

## EDA

```{r results='hide', message=F}
smb_eda <- smbinning::smbinning.eda(dataset[type=="train",])
```

### EDA Absolute

```{r}
cat(paste0("\nLegend:
Neg: number of negative values
Pos: number of positive values
OutLo: Number of outliers (records below Q25-1.5*IQR, where IQR=Q75-Q25)
OutHi: Number of outliers (records above Q75+1.5*IQR, where IQR=Q75-Q25)\n"))
DT::datatable(smb_eda$eda, options = list(scrollX = TRUE, pageLength = 20))
# Heatmap
stats::heatmap(as.matrix(scale(smb_eda$eda[-c(which(smb_eda$eda$Field %in% c(TARGET_COL, ID_COL, "type"))),-c(1:4)])))
```

### EDA Percentage

```{r}
DT::datatable(smb_eda$edapct, options = list(scrollX = TRUE, pageLength = 20))
```

### Variables With Missings

```{r}
smb_eda$eda[which(smb_eda$eda$Miss > 0),]
```

### More Statistics Of Numeric Variables

```{r}
if (!is.null(vec_num)){
  cat(paste("\nLegend:
  MAD: mean absolute deviation
  CV: coefficient of variation (relative standard deviation)\n"))

  DT::datatable(fastNumStats(dataset[type=="train",]), options = list(scrollX = TRUE, pageLength = 20)) %>%
    formatRound(columns=c(2:6), digits=3)
}
```

### Summary Statistics Of Categorical Variables

```{r}
if (!is.null(vec_cat)){
  DT::datatable(summarytools::freq(dataset[,vec_cat,with=F]), options = list(scrollX = TRUE, pageLength = 20))
}
```

## Analyze ID_COL

```{r}
cat("\nCount of duplicated IDs:", sum(duplicated(dataset[type=="train",get(ID_COL)])), "\n\n")
```

## Analyze TARGET_COL

```{r}
summarytools::freq(dataset[type=="train",get(TARGET_COL)])
```

# Write Options File

```{r}
# generate empty _options.R file
suppressMessages(suppressWarnings(file.create("_options.R")))
# write vec_num
if (!is.null(vec_num)){
  out.vec_num <- paste0("vec_num = c('", paste(vec_num, collapse = "', '"), "')\n\n")
} else {
  out.vec_num <- paste0("vec_num = NULL\n\n")
}
# write vec_cat
if (!is.null(vec_cat)){
  out.vec_cat <- paste0("vec_cat = c('", paste(vec_cat, collapse = "', '"), "')\n\n")
} else {
  out.vec_cat <- paste0("vec_cat = NULL\n\n")
}
# generate message
message_out <- paste0("ID_COL = '", ID_COL, "'\n",
                      "TARGET_COL = '", TARGET_COL, "'\n\n",
                      out.vec_num,
                      out.vec_cat, "\n\n")
# write message to file
write(message_out, file = "_options.R")
rm(message_out, out.vec_cat, out.vec_num)
invisible(gc())
```

# Save Dataset

```{r}
if (!dir.exists("./export/")){
  dir.create("./export/")
}
fwrite(dataset, "./export/dataset.csv",
            row.names = F,
            sep = ",",
            dec = ".")
invisible(gc())
save.image()
```
